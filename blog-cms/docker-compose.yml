version: '3.8'

services:
  blog-cms:
    build: .
    container_name: ${CONTAINER_NAME:-blog-cms}
    restart: unless-stopped
    volumes:
      # Mount the blog repository
      - ${HOST_REPO_PATH}:/repo
      # Mount SSH keys for git push
      - ${HOST_SSH_PATH}:/home/appuser/.ssh:ro
      # Mount git credentials
      - ${HOST_GITCONFIG_PATH}:/home/appuser/.gitconfig:ro
    environment:
      # Load from .env file
      - REPO_PATH=${REPO_PATH}
      - CMS_USERNAME=${CMS_USERNAME}
      - CMS_PASSWORD=${CMS_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL}
      - GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME}
      - GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL}
    networks:
      - lan
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # Router configuration
      - "traefik.http.routers.blog-cms.rule=Host(`${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.blog-cms.entrypoints=https"
      - "traefik.http.routers.blog-cms.tls=true"
      - "traefik.http.routers.blog-cms.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-letsencrypt}"

      # Service configuration
      - "traefik.http.services.blog-cms.loadbalancer.server.port=5000"

      # Middleware (optional - add rate limiting, auth, etc.)
      # - "traefik.http.routers.blog-cms.middlewares=blog-cms-ratelimit"
      # - "traefik.http.middlewares.blog-cms-ratelimit.ratelimit.average=100"

networks:
  lan:
    external: true
