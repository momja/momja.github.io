<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Github Pages with Jinja and Github Actions</title>
    <link rel="stylesheet" href="../../tailwind.css">
    <script src="https://kit.fontawesome.com/675a0d1294.js" crossorigin="anonymous"></script>
    <style>
        #main {
            margin: auto;
            text-align: justify;
            width: 45rem;
        }
        
        h1 {
            font-size: 3rem;
            text-align: center;
        }
        
        h2 {
            padding-top: 2rem;
            font-size: 2rem;
            text-align: left;
        }
        
        h3 {
            padding-top: 1.5rem;
            font-size: 1.5rem;
            text-align: left;
        }
        
        h4 {
            padding-top: 1.5rem;
            font-size: 1.5rem;
            text-align: left;
            color: darkslategray;
        }
        
        p:first-of-type::first-letter {
            font-size: 4rem;
        }
        
        p {
            font-size: 1rem;
        }
        
        img,
        video {
            width: 42rem;
            margin: auto;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
    </style>
    <script>
        function goBack() {
            window.history.back();
        }
    </script>
</head>

<body class="theme">
    <div class='back-button'>
        <button class="bg-transparent mt-8 ml-8" onclick="goBack()">
            ‚Üê Back
        </button>
    </div>
    <label class="theme-switch switch" for="checkbox">
    <input type="checkbox" id="checkbox" />
    <span class="slider round"></span>
</label>


<script>
const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');

function switchTheme(e) {
    if (e.target.checked) {
        document.documentElement.setAttribute('data-theme', 'dark');
    }
    else {
        document.documentElement.setAttribute('data-theme', 'light');
    }
}

toggleSwitch.addEventListener('change', switchTheme, false);
</script>

    <div id="main">
        <p>This blog, like many others is hosted on <a href="https://pages.github.com/">Github Pages</a>. Github Pages is a great (and free) way to post small static sites like personal websites. The annoying thing is that you have to push build code that would <em>usually</em> be included in your <code>.gitignore</code> file. So if you don't want to have to build your site locally, and include the build files in your repository, there is an option for you that leverages Github Actions.</p>

<p>Now, if you haven't heard of <a href="https://github.com/features/actions">Github Actions</a>, you should check it out. It's Github's platform for CI/CD, and it's easily configurable with .yaml files. There's nothing special you have to do for a repository, you just include the action files in the <code>.github/workflows</code> directory.</p>

<p><a href="https://github.com/momja/momja.github.io">My site repository</a> is currently being deployed with a <a href="https://github.com/JamesIves/github-pages-deploy-action">github action</a> written by <a href="https://github.com/JamesIves"><code>@JamesIves</code></a>. The sample <code>.yaml</code> file looks like this:</p>

<div class="codehilite"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build and Deploy</span>
<span class="nt">on</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">]</span>
<span class="nt">permissions</span><span class="p">:</span> 
  <span class="nt">contents</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">write</span>
<span class="nt">jobs</span><span class="p">:</span>
  <span class="nt">build-and-deploy</span><span class="p">:</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout üõéÔ∏è</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install and Build üîß</span>
        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">npm ci</span>
          <span class="no">npm run build</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy üöÄ</span>
        <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">JamesIves/github-pages-deploy-action@v4.3.3</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">branch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gh-pages</span>
          <span class="nt">folder</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build</span>
</code></pre></div>

<p>There's very little here we have to change to get this working for us.</p>

<ol>
<li><p>first, make sure this section matches the branch your github site is hosted on. You can check which branch is currently used by opening your github pages repository then:
 Settings -> Code and Automation -> Pages -> Source.</p>

<div class="codehilite"><pre><span></span><code><span class="nt">with</span><span class="p">:</span>
    <span class="nt">branch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gh-pages &lt;- make sure this matches &quot;branch&quot;</span>
    <span class="nt">folder</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build</span>
</code></pre></div>

<p>![[Pasted image 20220614194517.png]]</p></li>
<li><p>Now we need to update the "Install and Build üîß" section. There are a couple things we have to do for this to work, and it will vary for you depending on how your site is being built. I'm generating the static pages of my site using the Jinja web templating engine, and then I inject style with Postcss and Tailwind. This means I need to run a python script to generate the HTML files, then run a postcss injection to transform my css. I've got <a href="https://github.com/momja/momja.github.io/blob/master/package.json">all this configured</a> in my 'package.json' file, so whenever I run <code>npm run build</code>, all this is taken care of. At least that all happens smoothly locally. When running this on some ephemeral virtual machine, you have to actually make sure all the dependencies are downloaded first. For the postcss dependencies, that's as simple as running <code>npm install</code> assuming you've correctly set up your packages.</p>

<p>For Python, it is a little different. I'm not the biggest fan of dependency management in Python, but I recently came across a tool called <a href="https://github.com/bndr/pipreqs">pipreqs</a> which solves the challenges I associate with generating package requirements for Python. To build a requirements.txt file with pipreqs, just run <code>pipreqs</code> in your project directory. You will want to include this requirements file in your git commit, because we will then use it to install all the pip dependencies on the VM used by Github Actions!</p>

<div class="codehilite"><pre><span></span><code><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install and Build üîß</span>
  <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">npm ci</span>
    <span class="no">npm run build</span>
</code></pre></div>

<p>becomes:</p>

<div class="codehilite"><pre><span></span><code><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install and Build üîß</span>
  <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">pip install -r requirements.txt</span>
    <span class="no">npm install</span>
    <span class="no">npm run build</span>
</code></pre></div></li>
<li><p>Lastly, I didn't want the <code>gh-pages</code> branch to be updated each time a change is made to <em>any</em> branch, so I changed the yaml field at the top of the file for when the action should be triggered:
 <div class="codehilite"><pre><span></span><code><span class="nt">on</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">]</span>
 </code></pre></div></p>

<p>becomes:
 <div class="codehilite"><pre><span></span><code><span class="nt">on</span><span class="p">:</span>
     <span class="nt">push</span><span class="p">:</span>
         <span class="nt">branches</span><span class="p">:</span>
             <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
 </code></pre></div></p></li>
</ol>

<p>And there you have it! Check out the final file <a href="https://github.com/momja/momja.github.io/blob/38e1a2985c1983cbd35c07d970318d8743cb63ba/.github/workflows/deploy-to-gh-pages.yml">here</a></p>

    </div>
</body>

</html>