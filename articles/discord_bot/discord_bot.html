<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing a Discord bot with Python and aiocron</title>
    <link rel="stylesheet" href="../../tailwind.css">
    <link rel="stylesheet" href="../../codestyle.css">
    <link rel="icon" type="image/png" href="../../favicon.png">
    <script src="https://kit.fontawesome.com/675a0d1294.js" crossorigin="anonymous"></script>
    <script data-goatcounter="https://dizzard.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <style>
        ol {
            list-style-type: decimal;
        }
    </style>
    <script>
        function goBack() {
            window.history.back();
        }
    </script>
</head>

<body class="bg-white dark:bg-slate-800">
    <div class='back-button mt-8 text-center md:text-left md:ml-8'>
        <button class="bg-transparent text-slate-900 dark:text-white" onclick="goBack()">
            ‚Üê Back
        </button>
    </div>
    <div class="m-4 md:flex md:justify-center">
        <article class="prose lg:prose-xl dark:prose-invert">
            <p class="text-sm text-gray-600 dark:text-gray-400">Published: 2023-04-22</p>
            <h1>Writing a Discord bot with Python and aiocron</h1>

<p>I wanted to write a Discord bot to provide simple scheduled alerts for the <a href="https://noisebridge.net">hackerspace</a> I am a part of. We have a channel for the woodshop, and every so often, we need to empty the dust collector and scrap bins.</p>

<p>After some basic research, I found it was pretty straightforward how to set up a bot in the discord developer portal, so I'm not going to go through that here, but if you need help, you can check out <a href="https://realpython.com/how-to-make-a-discord-bot-python/">this realpython article</a>.</p>

<p>Instead, I want to focus on a snag I ran into while trying to use <a href="https://github.com/gawel/aiocron">aiocron</a> with <a href="https://discordpy.readthedocs.io/en/stable/">discord.py</a>. The python discord library now offers some neat tricks for timing method runs with the annotation <code class="codeblock">@tasks.loop(...)</code>, but this doesn't let you <em>schedule</em> async method calls by day or time, so you have to provide some extra code to make sure you start the loop at the right moment in time for it to work correctly. aiocron is neat because it uses crontab format for scheduling method calls. </p>

<p>Now, when I first tried to get this running, I encountered issues with the event loop. My understanding is that the discord library made <a href="https://discordpy.readthedocs.io/en/stable/migrating.html?highlight=2%200#asyncio-event-loop-changes">some changes</a> in it's 2.0 version that allows you to create your own asynchronous loop for running the bot. If you <em>don't</em> use this loop, I'm not sure how you set up other asynchronous code.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">discord</span>
<span class="kn">import</span> <span class="nn">aiocron</span>
<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="n">TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DISCORD_TOKEN&#39;</span><span class="p">)</span>
<span class="n">GUILD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DISCORD_GUILD&#39;</span><span class="p">)</span>
<span class="n">WOODSHOP_CHANNEL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;WOODSHOP_CHANNEL&#39;</span><span class="p">)</span>

<span class="n">trash_message</span> <span class="o">=</span> <span class="s2">&quot;This is your friendly reminder to take out the shop bins and empty the dust collector!&quot;</span>

<span class="n">bot</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">case_insensitive</span><span class="o">=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">intents</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Intents</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">help_command</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<span class="nd">@aiocron</span><span class="o">.</span><span class="n">crontab</span><span class="p">(</span><span class="s1">&#39;0 12 * * 0&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span> <span class="c1"># every sunday at noon</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">trash_reminder</span><span class="p">():</span>
    <span class="n">woodshop_channel</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">WOODSHOP_CHANNEL</span><span class="p">))</span>
    <span class="k">await</span> <span class="n">woodshop_channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">trash_message</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">bot</span><span class="p">:</span>
        <span class="n">trash_reminder</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">)</span>

<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre>
</div>

<p>By using the variable <code class="codeblock">loop</code> as my async loop, I can provide that to the crontab annotation, and voila! Things start working.</p>

<p>Now, if you are like me and don't know that format off the top of your head, what I did is ask old ChatGPT, who gave a prompt answer and description. Work smarter, not harder!</p>

<p>Not so much of a tutorial, but I'm hoping someone finds this code snippet helpful, because I couldn't find an example of this myself. I did, however find <a href="https://www.reddit.com/r/Discord_Bots/comments/vxknqz/aiocroncronjob_not_working_with_discordpy_v20/">some</a> <a href="https://github.com/Rapptz/discord.py/issues/7986">people</a> running into similar issues.</p>

<p>Anyways, happy hacking!</p>

        </article>
    </div>
    <div class="p-5 m-4 md:flex md:justify-center">
        <!-- kofi button -->
        <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Support Me on Ko-fi', '#000000', 'I2I4QBRVN');kofiwidget2.draw();</script>
    </div>

</body>

</html>